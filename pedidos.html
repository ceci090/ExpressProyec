<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Pedidos</title>
    <link rel="stylesheet" href="/pedidos.css">
    <script>
        const API_URL = "https://palegreen-starling-110684.hostingersite.com/pedido.php";
        let pedidoEditando = null;
        let pedidos = [];
        let paginaActual = 1;
        const pedidosPorPagina = 5;

        async function cargarPedidos() {
            try {
                const respuesta = await fetch(API_URL);
                pedidos = await respuesta.json();
                const mostrar = pedidos.slice((paginaActual - 1) * pedidosPorPagina, paginaActual * pedidosPorPagina);

                const tabla = document.getElementById("tabla-pedidos").getElementsByTagName('tbody')[0];
                tabla.innerHTML = mostrar.map(p => `
                    <tr>
                        <td>${p.sucursal}</td>
                        <td>${p.fecha_pedido}</td>
                        <td>${p.cantidad}</td>
                        <td>${p.usuario}</td>
                        <td>${p.estado}</td>
                        <td>${p.monto_total}</td>
                      <td>
    <button class="edit-btn" onclick="editarPedido(${p.d_pedido})">Editar</button>
    <button class="btn-eliminar" onclick="eliminarPedido(${p.d_pedido})">Eliminar</button>
</td>

                    </tr>
                `).join("");

                actualizarPaginacion();
            } catch (error) {
                console.error("Error al cargar los pedidos:", error);
                mostrarMensaje("Hubo un problema al cargar los pedidos.");
            }
        }

        async function eliminarPedido(id) {
            if (confirm("¿Estás seguro de que quieres eliminar este pedido?")) {
                try {
                    const response = await fetch(`${API_URL}?d_pedido=${id}`, { method: 'DELETE' });
                    const data = await response.json();
                    if (data.success) {
                        alert("Pedido eliminado correctamente");
                        cargarPedidos();
                    } else {
                        mostrarMensaje("Error al eliminar el pedido.");
                    }
                } catch (error) {
                    console.error("Error al eliminar el pedido:", error);
                    mostrarMensaje("Hubo un problema al eliminar el pedido.");
                }
            }
        }

        function actualizarPaginacion() {
            const totalPaginas = Math.ceil(pedidos.length / pedidosPorPagina);
            const paginacion = document.getElementById("paginacion");
            paginacion.innerHTML = `
                <button onclick="cambiarPagina(${paginaActual - 1})" ${paginaActual === 1 ? 'disabled' : ''}>Anterior</button>
                <span>Página ${paginaActual} de ${totalPaginas}</span>
                <button onclick="cambiarPagina(${paginaActual + 1})" ${paginaActual === totalPaginas ? 'disabled' : ''}>Siguiente</button>
            `;
        }

        function cambiarPagina(nuevaPagina) {
            const totalPaginas = Math.ceil(pedidos.length / pedidosPorPagina);
            if (nuevaPagina >= 1 && nuevaPagina <= totalPaginas) {
                paginaActual = nuevaPagina;
                cargarPedidos();
            }
        }

        function mostrarFormulario() {
            document.getElementById("modal").style.display = "block";
        }

        function cerrarFormulario() {
            document.getElementById("modal").style.display = "none";
            document.getElementById("form-pedido").reset();
            pedidoEditando = null;
            limpiarMensajes();
        }

        function mostrarMensaje(mensaje) {
            const mensajeDiv = document.getElementById("mensaje-error");
            mensajeDiv.textContent = mensaje;
            mensajeDiv.style.display = "block";
        }

        function limpiarMensajes() {
            const mensajeDiv = document.getElementById("mensaje-error");
            mensajeDiv.textContent = "";
            mensajeDiv.style.display = "none";
        }

        async function guardarPedido() {
            limpiarMensajes();

            const pedido = {
                // Podés fijar el id_cliente si es necesario
                id_cliente: 1, // valor por defecto o dinámico si tenés login
                sucursal: document.getElementById("sucursal").value,
                fecha_pedido: document.getElementById("fecha_pedido").value,
                cantidad: document.getElementById("cantidad").value,
                usuario: document.getElementById("usuario").value,
                estado: document.getElementById("estado").value,
                monto_total: document.getElementById("monto_total").value
            };

            let response;
            if (pedidoEditando) {
                pedido.d_pedido = pedidoEditando.d_pedido;
                response = await fetch(API_URL, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(pedido)
                });
            } else {
                response = await fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(pedido)
                });
            }

            const data = await response.json();
            if (data.success) {
                alert("Pedido guardado correctamente");
                cargarPedidos();
                cerrarFormulario();
            } else {
                mostrarMensaje("Error al guardar el pedido.");
            }
        }

        function editarPedido(id) {
            const pedido = pedidos.find(p => p.d_pedido == id);
            if (!pedido) return;

            pedidoEditando = pedido;
            // document.getElementById("id_cliente").value = pedido.id_cliente; // oculto
            document.getElementById("sucursal").value = pedido.sucursal;
            document.getElementById("fecha_pedido").value = pedido.fecha_pedido;
            document.getElementById("cantidad").value = pedido.cantidad;
            document.getElementById("usuario").value = pedido.usuario;
            document.getElementById("estado").value = pedido.estado;
            document.getElementById("monto_total").value = pedido.monto_total;

            mostrarFormulario();
        }

        document.addEventListener("DOMContentLoaded", cargarPedidos);
    </script>
</head>
<body>
  <nav>
    <ul>
      <li><a href="menu.html">Inicio</a></li>

      <li><a href="#">Administración</a>
        <ul>
          <li><a href="#">Gestión Personal</a>
            <ul>
              <li><a href="empleados.html">Empleados</a></li>
              <li><a href="usuarios.html">Usuarios</a></li> 
            </ul>
          </li>
          <li><a href="#">Gestión Financiera</a>
            <ul>
              <li><a href="ventas.html">Ventas</a></li>
              <li><a href="gastos.html">Gastos</a></li>
            </ul>
          </li>
        </ul>
      </li>

      <li><a href="#">Operaciones</a>
        <ul>
          <li><a href="#">Gestión de Producción</a>
            <ul>
              <li><a href="produccion.html">Producción</a></li>
              <li><a href="maquina.html">Máquina</a></li>
            </ul>
          </li>
          <li><a href="#">Gestión de Abastecimientos</a>
            <ul>
              <li><a href="proveedores.html">Proveedores</a></li>
              <li><a href="inventario.html">Inventario</a></li>
            </ul>
          </li>
        </ul>
      </li>

      <li><a href="#">Comercialización</a>
        <ul>
          <li><a href="#">Relaciones con Clientes</a>
            <ul>
              <li><a href="clientes.html">Clientes</a></li>
            </ul>
          </li>
          <li><a href="#">Logística de Pedidos</a>
            <ul>
              <li><a href="pedidos.html">Pedidos</a></li>
            </ul>
          </li>
        </ul>
             <!-- Agregar el enlace para cerrar sesión al final del menú -->
             <li><a href="#" onclick="handleLogout()">Cerrar sesión</a></li>
            </ul>
          </nav>
        
          <script>
            function handleLogout() {
              // Redirige al usuario a la página de inicio de sesión o página principal
              window.location.href = 'index.html'; // O cualquier otra página donde se maneje el cierre de sesión
            }
          </script>
          
    <div class="container">
        <h1>Gestión de Pedidos</h1>
        <button class="btn-agregar" onclick="mostrarFormulario()">Agregar Pedido</button>
    </div>

    <table id="tabla-pedidos">
        <thead>
            <tr>
                <!-- Columnas ocultas: ID Pedido e ID Cliente -->
                <th>Sucursal</th>
                <th>Fecha</th>
                <th>Cantidad</th>
                <th>Usuario</th>
                <th>Estado</th>
                <th>Monto Total</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div id="paginacion"></div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <h2>Ingrese los datos del pedido</h2>
            <form id="form-pedido">
                <!-- Campo oculto: ID Cliente -->
                <!-- <label for="id_cliente">ID Cliente:</label>
                <input type="text" id="id_cliente" required> -->

                <label for="sucursal">Sucursal:</label>
                <input type="text" id="sucursal" required>

                <label for="fecha_pedido">Fecha del Pedido:</label>
                <input type="date" id="fecha_pedido" required>

                <label for="cantidad">Cantidad:</label>
                <input type="number" id="cantidad" required>

                <label for="usuario">Usuario:</label>
                <input type="text" id="usuario" required>

                <label for="estado">Estado:</label>
                <input type="text" id="estado" required>

                <label for="monto_total">Monto Total:</label>
                <input type="number" id="monto_total" required>

                <button type="button" onclick="guardarPedido()">Guardar</button>
                <button type="button" onclick="cerrarFormulario()">Cerrar</button>
            </form>
            <div id="mensaje-error" style="color: red; display: none;"></div>
        </div>
    </div>
</body>
</html>
